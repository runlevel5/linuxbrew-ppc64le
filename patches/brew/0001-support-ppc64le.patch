From 24e943568e6c630f8d3143f89536b50870e75e62 Mon Sep 17 00:00:00 2001
From: tle <tle@orion.dev>
Date: Wed, 5 Feb 2020 00:58:08 -0500
Subject: [PATCH] Support ppc64le

---
 Library/Homebrew/cmd/vendor-install.sh           |  5 +++++
 Library/Homebrew/extend/os/linux/hardware/cpu.rb |  7 +++++--
 Library/Homebrew/extend/os/linux/install.rb      |  1 +
 Library/Homebrew/hardware.rb                     |  7 +++++--
 Library/Homebrew/install.rb                      | 12 ------------
 5 files changed, 16 insertions(+), 16 deletions(-)

diff --git a/Library/Homebrew/cmd/vendor-install.sh b/Library/Homebrew/cmd/vendor-install.sh
index fdd491362..1a37db38c 100644
--- a/Library/Homebrew/cmd/vendor-install.sh
+++ b/Library/Homebrew/cmd/vendor-install.sh
@@ -39,6 +39,11 @@ then
       ruby_URL2="https://github.com/Homebrew/homebrew-portable-ruby/releases/download/2.6.3/portable-ruby-2.6.3.armv6_linux.bottle.tar.gz"
       ruby_SHA="78e36e4671fd08790bfbfda4408d559341c9872bf48a4f6eab78157a3bf3efa6"
       ;;
+    ppc64le)
+      ruby_URL="https://raw.githubusercontent.com/runlevel5/linuxbrew-ppc64le/master/portable-ruby-2.6.3.ppc64le_linux.bottle.tar.gz"
+      ruby_URL2="https://raw.githubusercontent.com/runlevel5/linuxbrew-ppc64le/master/portable-ruby-2.6.3.ppc64le_linux.bottle.tar.gz"
+      ruby_SHA="e083051b98d125a62c646c32a7d3795113a70ac462ea6db7339ac6579100a292"
+      ;;
   esac
 fi
 
diff --git a/Library/Homebrew/extend/os/linux/hardware/cpu.rb b/Library/Homebrew/extend/os/linux/hardware/cpu.rb
index a0530ea98..779d20372 100644
--- a/Library/Homebrew/extend/os/linux/hardware/cpu.rb
+++ b/Library/Homebrew/extend/os/linux/hardware/cpu.rb
@@ -11,10 +11,13 @@ module Hardware
         core:    "-march=prescott",
         armv6:   "-march=armv6",
         armv8:   "-march=armv8-a",
-      }.freeze
+        ppc:     "-mcpu=native -mtune=native",
+      }
 
       def optimization_flags
-        OPTIMIZATION_FLAGS_LINUX
+        OPTIMIZATION_FLAGS_LINUX.tap do |flags|
+          flags[:native] = "-mcpu=native -mtune=native" if ppc?
+        end
       end
 
       def cpuinfo
diff --git a/Library/Homebrew/extend/os/linux/install.rb b/Library/Homebrew/extend/os/linux/install.rb
index 7efbff87d..f39acfa9e 100644
--- a/Library/Homebrew/extend/os/linux/install.rb
+++ b/Library/Homebrew/extend/os/linux/install.rb
@@ -6,6 +6,7 @@ module Homebrew
 
     DYNAMIC_LINKERS = [
       "/lib64/ld-linux-x86-64.so.2",
+      "/lib64/ld64.so.2",
       "/lib/ld-linux.so.3",
       "/lib/ld-linux.so.2",
       "/lib/ld-linux-aarch64.so.1",
diff --git a/Library/Homebrew/hardware.rb b/Library/Homebrew/hardware.rb
index 37fd2c49c..6ca81f300 100644
--- a/Library/Homebrew/hardware.rb
+++ b/Library/Homebrew/hardware.rb
@@ -15,10 +15,13 @@ module Hardware
         core:    "-march=prescott",
         armv6:   "-march=armv6",
         armv8:   "-march=armv8-a",
+        ppc:     "-mcpu=native -mtune=native",
       }.freeze
 
       def optimization_flags
-        OPTIMIZATION_FLAGS
+        OPTIMIZATION_FLAGS_LINUX.tap do |flags|
+          flags[:native] = "-mcpu=native -mtune=native" if ppc?
+        end
       end
 
       def arch_32_bit
@@ -64,7 +67,7 @@ module Hardware
         case RUBY_PLATFORM
         when /x86_64/, /i\d86/ then :intel
         when /arm/, /aarch64/ then :arm
-        when /ppc\d+/ then :ppc
+        when /ppc\d+/, /powerpc/ then :ppc
         else :dunno
         end
       end
diff --git a/Library/Homebrew/install.rb b/Library/Homebrew/install.rb
index 86d63161f..011cfdd6c 100644
--- a/Library/Homebrew/install.rb
+++ b/Library/Homebrew/install.rb
@@ -9,17 +9,6 @@ module Homebrew
   module Install
     module_function
 
-    def check_cpu
-      case Hardware::CPU.type
-      when :ppc
-        abort <<~EOS
-          Sorry, Homebrew does not support your computer's CPU architecture.
-          For PPC support, see:
-            #{Formatter.url("https://github.com/mistydemeo/tigerbrew")}
-        EOS
-      end
-    end
-
     def attempt_directory_creation
       Keg::MUST_EXIST_DIRECTORIES.each do |dir|
         FileUtils.mkdir_p(dir) unless dir.exist?
@@ -45,7 +34,6 @@ module Homebrew
     end
 
     def perform_preinstall_checks(all_fatal: false)
-      check_cpu
       attempt_directory_creation
       check_cc_argv
       diagnostic_checks(:supported_configuration_checks, fatal: all_fatal)
-- 
2.25.0

